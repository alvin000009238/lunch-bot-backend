<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>午餐訂餐系統 - 後台管理</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 2rem; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; margin: 1rem auto; }
        h1, h2 { color: #333; text-align: center; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: #555; font-weight: 600; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        button { padding: 0.85rem; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; width: 100%; }
        button:hover { background-color: #0056b3; }
        .message-box { margin-top: 1.5rem; padding: 1rem; border-radius: 5px; text-align: center; font-weight: bold; display: none; }
        .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        #login-container { max-width: 400px; }
        #login-form .form-group { margin-bottom: 1.5rem; }
        
        #main-content { display: none; }
        #user-list { list-style-type: none; padding: 0; }
        #user-list li { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; }
        .user-info { flex-grow: 1; }
        .user-deposit { display: flex; align-items: center; margin-top: 0.5rem; width: 100%; }
        @media (min-width: 600px) { .user-deposit { width: auto; margin-top: 0; } }
        .user-deposit input { width: 80px; margin-right: 0.5rem; }
        .user-deposit button { width: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 0.75rem; text-align: left; word-break: break-word; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .section-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .section-header > div { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .refresh-btn { padding: 0.5rem 1rem; font-size: 0.9rem; width: auto; }
        .menu-input-grid { display: grid; grid-template-columns: 60px 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .menu-input-grid.combo-eligible { background-color: #e3f2fd; }
        .menu-input-grid label { margin-bottom: 0; font-size: 1.1rem; font-weight: bold; }
        .price-group { display: flex; gap: 5px; }
        .price-group select { flex-grow: 1; }
        .price-group input { width: 80px; }
        .settings-grid { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; }
        .settings-grid button { width: auto; }
        
        .status-finished { background-color: #d4edda; color: #155724; }
        .status-preparing { background-color: #fff3cd; color: #856404; }
        .status-cancelled_by_system, .status-cancelled_by_user { background-color: #f8d7da; color: #721c24; text-decoration: line-through; }

        #vision-upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        #vision-upload-section h3 {
            margin-top: 0;
            color: #0056b3;
        }
        /* ✨ 新增: 雙圖上傳樣式 ✨ */
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1rem 0;
        }
        .upload-box {
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 5px;
        }
        .upload-box label {
            font-size: 1.1rem;
            color: #333;
        }
        .upload-box input[type="file"] {
            margin-top: 0.5rem;
        }
        #upload-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 登入表單容器 -->
    <div id="login-container" class="container">
        <h2>後台管理登入</h2>
        <form id="login-form" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="username">使用者名稱</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">密碼</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">登入</button>
        </form>
        <div id="login-message" class="message-box"></div>
    </div>

    <!-- 主內容容器 (預設隱藏) -->
    <div id="main-content">
        <div class="container">
            <div class="section-header">
                <h2>每日菜單管理</h2>
                <div>
                    <input type="date" id="menu-date-selector">
                    <button onclick="saveDailyMenu()" class="refresh-btn" style="background-color: #28a745;">儲存當日菜單</button>
                </div>
            </div>
            
            <!-- ✨ 修改: 智慧菜單上傳區塊 (雙圖) ✨ -->
            <div id="vision-upload-section">
                <h3>智慧菜單上傳 (雙圖模式)</h3>
                <p>請分別上傳「單點」和「套餐」的菜單圖片。</p>
                <div class="upload-grid">
                    <div class="upload-box">
                        <label for="single-items-image">單點菜單 (8項)</label>
                        <input type="file" id="single-items-image" accept="image/*">
                    </div>
                    <div class="upload-box">
                        <label for="combo-items-image">套餐菜單 (3項)</label>
                        <input type="file" id="combo-items-image" accept="image/*">
                    </div>
                </div>
                <button onclick="uploadAndParseMenu()" id="upload-btn">上傳並解析</button>
                <div id="upload-spinner"></div>
            </div>
            
            <div id="daily-menu-form"></div>
            <div id="daily-menu-message" class="message-box"></div>
        </div>

        <div class="container">
            <h2>使用者管理與儲值</h2>
            <ul id="user-list"></ul>
            <div id="user-message" class="message-box"></div>
        </div>

        <div class="container">
            <div class="section-header">
                <h2>訂單列表</h2>
                <div>
                    <input type="date" id="order-date-filter">
                    <button onclick="loadOrders()" class="refresh-btn">查詢訂單</button>
                </div>
            </div>
            <table id="order-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>訂購人</th>
                        <th>品項</th>
                        <th>金額</th>
                        <th>狀態</th>
                        <th>用餐日</th>
                        <th>下單時間</th>
                    </tr>
                </thead>
                <tbody id="order-list"></tbody>
            </table>
            <div id="order-message" class="message-box"></div>
        </div>

        <div class="container">
            <h2>系統設定</h2>
            <div id="settings-form">
                 <div class="settings-grid">
                    <label for="deadline-time">訂單截止時間</label>
                    <input type="time" id="deadline-time">
                    <button onclick="saveSettings()" style="background-color: #17a2b8;">儲存設定</button>
                </div>
            </div>
            <div id="settings-message" class="message-box"></div>
        </div>
    </div>

    <script>
        const backendUrl = 'https://line-bot-backend-167812150750.asia-east1.run.app'; // ✨ 請記得更新此網址
        
        // DOM 元素
        const loginContainer = document.getElementById('login-container');
        const mainContent = document.getElementById('main-content');
        const loginMessageDiv = document.getElementById('login-message');
        
        const menuDateSelector = document.getElementById('menu-date-selector');
        const dailyMenuForm = document.getElementById('daily-menu-form');
        const dailyMenuMessageDiv = document.getElementById('daily-menu-message');
        const userList = document.getElementById('user-list');
        const userMessageDiv = document.getElementById('user-message');
        const orderList = document.getElementById('order-list');
        const orderMessageDiv = document.getElementById('order-message');
        const orderDateFilter = document.getElementById('order-date-filter');
        const settingsMessageDiv = document.getElementById('settings-message');
        const deadlineTimeInput = document.getElementById('deadline-time');

        const uploadBtn = document.getElementById('upload-btn');
        const uploadSpinner = document.getElementById('upload-spinner');

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${backendUrl}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showMainContent();
                } else {
                    const result = await response.json();
                    showMessage(loginMessageDiv, result.error || '登入失敗', 'error');
                }
            } catch (error) {
                showMessage(loginMessageDiv, `發生錯誤: ${error.message}`, 'error');
            }
        }

        function showMainContent() {
            loginContainer.style.display = 'none';
            mainContent.style.display = 'block';
            document.body.style.alignItems = 'flex-start';
            document.body.style.justifyContent = 'center';

            const today = new Date().toLocaleDateString('en-CA');
            menuDateSelector.value = today;
            orderDateFilter.value = today;
            
            loadUsers();
            loadOrders();
            loadDailyMenu();
            loadSettings();
        }

        window.onload = () => {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showMainContent();
            }
        };
        
        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = `message-box message-${type}`;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }
        
        function generateMenuInputForm(menuItems = []) {
            dailyMenuForm.innerHTML = '';
            const priceOptions = `<option value="65">65元</option><option value="70">70元</option><option value="75">75元</option><option value="custom">手動</option>`;
            for (let i = 1; i <= 11; i++) {
                const item = menuItems.find(m => m.display_order === i) || {};
                const isComboEligible = i > 8;
                const labelText = isComboEligible ? `套餐 ${i-8}` : `單點 ${i}`;
                const itemHtml = `<div class="menu-input-grid ${isComboEligible ? 'combo-eligible' : ''}"><label for="name-${i}">${labelText}</label><input type="text" id="name-${i}" placeholder="品項名稱" value="${item.name || ''}"><div class="price-group"><select id="price-select-${i}" onchange="togglePriceInput(${i})">${priceOptions}</select><input type="number" id="price-input-${i}" placeholder="價格" style="display:none;" value="${item.price || ''}"></div></div>`;
                dailyMenuForm.insertAdjacentHTML('beforeend', itemHtml);
                const priceSelect = document.getElementById(`price-select-${i}`);
                const priceInput = document.getElementById(`price-input-${i}`);
                
                if (item.price) {
                    const priceValue = parseFloat(item.price);
                    if ([65, 70, 75].includes(priceValue)) {
                        priceSelect.value = priceValue;
                        priceInput.style.display = 'none';
                    } else {
                        priceSelect.value = 'custom';
                        priceInput.value = priceValue;
                        priceInput.style.display = 'block';
                    }
                }
            }
        }

        function togglePriceInput(index) {
            const priceSelect = document.getElementById(`price-select-${index}`);
            const priceInput = document.getElementById(`price-input-${index}`);
            priceInput.style.display = priceSelect.value === 'custom' ? 'block' : 'none';
        }

        async function loadDailyMenu() {
            const selectedDate = menuDateSelector.value;
            if (!selectedDate) return;
            try {
                const response = await fetch(`${backendUrl}/admin/daily-menu?date=${selectedDate}`);
                if (!response.ok) throw new Error('無法取得菜單');
                const menuItems = await response.json();
                generateMenuInputForm(menuItems);
            } catch (error) {
                showMessage(dailyMenuMessageDiv, `載入菜單失敗: ${error.message}`, 'error');
                generateMenuInputForm();
            }
        }

        // ✨ 修改: 上傳並解析菜單圖片的函式 (雙圖)
        async function uploadAndParseMenu() {
            const singleItemsInput = document.getElementById('single-items-image');
            const comboItemsInput = document.getElementById('combo-items-image');

            if (singleItemsInput.files.length === 0 || comboItemsInput.files.length === 0) {
                showMessage(dailyMenuMessageDiv, '請務必同時上傳「單點」和「套餐」兩張菜單圖片', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadSpinner.style.display = 'block';

            try {
                const singleItemsImage = await readFileAsBase64(singleItemsInput.files[0]);
                const comboItemsImage = await readFileAsBase64(comboItemsInput.files[0]);

                const response = await fetch(`${backendUrl}/admin/parse-menu-from-image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        singleItemsImage: singleItemsImage.split(',')[1],
                        comboItemsImage: comboItemsImage.split(',')[1]
                    })
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || '解析失敗');
                }
                
                showMessage(dailyMenuMessageDiv, `成功解析到 ${result.length} 個品項！`, 'success');
                generateMenuInputForm(result);

            } catch (error) {
                showMessage(dailyMenuMessageDiv, `解析失敗: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadSpinner.style.display = 'none';
                singleItemsInput.value = '';
                comboItemsInput.value = '';
            }
        }
        
        // 輔助函式：將檔案讀取為 Base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }

        async function saveDailyMenu() {
            const selectedDate = menuDateSelector.value;
            const menuItems = [];
            for (let i = 1; i <= 11; i++) {
                const name = document.getElementById(`name-${i}`).value;
                const priceSelect = document.getElementById(`price-select-${i}`);
                let price = priceSelect.value === 'custom' ? parseFloat(document.getElementById(`price-input-${i}`).value) : parseFloat(priceSelect.value);
                if (name && price > 0) {
                    menuItems.push({ name: name, price: price, is_combo_eligible: i > 8, display_order: i });
                }
            }
            if (menuItems.length === 0) {
                showMessage(dailyMenuMessageDiv, '請至少輸入一項餐點', 'error');
                return;
            }
            try {
                const response = await fetch(`${backendUrl}/admin/daily-menu`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: selectedDate, items: menuItems })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '未知錯誤');
                showMessage(dailyMenuMessageDiv, '當日菜單儲存成功！', 'success');
            } catch (error) {
                showMessage(dailyMenuMessageDiv, `儲存失敗: ${error.message}`, 'error');
            }
        }
        
        async function loadUsers() {
            try {
                const response = await fetch(`${backendUrl}/admin/users`);
                if (!response.ok) throw new Error('無法取得使用者列表');
                const users = await response.json();
                userList.innerHTML = ''; 
                if (users.length === 0) {
                    userList.innerHTML = '<li>目前沒有已註冊的使用者。</li>';
                    return;
                }
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.innerHTML = `<div class="user-info"><strong>${user.display_name}</strong> (ID: ${user.id})<br>餘額: $<span id="balance-${user.id}">${parseFloat(user.balance).toFixed(2)}</span></div><div class="user-deposit"><input type="number" placeholder="金額" id="amount-${user.id}" min="1"><button onclick="deposit(${user.id})">儲值</button></div>`;
                    userList.appendChild(li);
                });
            } catch (error) {
                showMessage(userMessageDiv, `載入使用者失敗: ${error.message}`, 'error');
            }
        }
        async function deposit(userId) {
            const amountInput = document.getElementById(`amount-${userId}`);
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) {
                showMessage(userMessageDiv, '請輸入有效的儲值金額', 'error');
                return;
            }
            try {
                const response = await fetch(`${backendUrl}/admin/users/${userId}/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '未知錯誤');
                showMessage(userMessageDiv, `為 ${result.user.display_name} 儲值成功！`, 'success');
                document.getElementById(`balance-${userId}`).textContent = parseFloat(result.user.balance).toFixed(2);
                amountInput.value = '';
            } catch (error) {
                showMessage(userMessageDiv, `儲存失敗: ${error.message}`, 'error');
            }
        }
        async function loadOrders() {
            const selectedDate = orderDateFilter.value;
            if (!selectedDate) {
                showMessage(orderMessageDiv, '請選擇一個日期', 'error');
                return;
            }
            try {
                const response = await fetch(`${backendUrl}/admin/orders?date=${selectedDate}`);
                if (!response.ok) throw new Error('無法取得訂單列表');
                const orders = await response.json();
                orderList.innerHTML = '';
                if (orders.length === 0) {
                    orderList.innerHTML = '<tr><td colspan="7" style="text-align: center;">該日期沒有任何訂單。</td></tr>';
                    return;
                }
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    const orderForDate = new Date(order.order_for_date).toLocaleDateString('zh-TW');
                    const orderTime = new Date(order.created_at).toLocaleString('zh-TW', { hour12: false });
                    const statusClass = `status-${order.status.toLowerCase()}`;
                    tr.innerHTML = `<td>${order.id}</td><td>${order.display_name}</td><td>${order.items}</td><td>$${parseFloat(order.total_amount).toFixed(2)}</td><td class="${statusClass}">${order.status}</td><td>${orderForDate}</td><td>${orderTime}</td>`;
                    orderList.appendChild(tr);
                });
            } catch (error) {
                showMessage(orderMessageDiv, `載入訂單失敗: ${error.message}`, 'error');
            }
        }
        async function loadSettings() {
            try {
                const response = await fetch(`${backendUrl}/admin/settings`);
                if (!response.ok) throw new Error('無法取得系統設定');
                const settings = await response.json();
                deadlineTimeInput.value = settings.deadline_time;
            } catch (error) {
                showMessage(settingsMessageDiv, `載入設定失敗: ${error.message}`, 'error');
            }
        }
        async function saveSettings() {
            const deadlineTime = deadlineTimeInput.value;
            if (!deadlineTime) {
                showMessage(settingsMessageDiv, '請選擇一個有效的截止時間', 'error');
                return;
            }
            try {
                const response = await fetch(`${backendUrl}/admin/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deadline_time: deadlineTime })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '未知錯誤');
                showMessage(settingsMessageDiv, '設定儲存成功！', 'success');
            } catch (error) {
                showMessage(settingsMessageDiv, `儲存設定失敗: ${error.message}`, 'error');
            }
        }

        dailyMenuForm.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT') {
                    event.preventDefault();
                    const formElements = Array.from(dailyMenuForm.querySelectorAll('input, select'));
                    const currentIndex = formElements.indexOf(activeElement);
                    const nextElement = formElements[currentIndex + 1];
                    if (nextElement) {
                        nextElement.focus();
                    }
                }
            }
        });
        menuDateSelector.addEventListener('change', loadDailyMenu);
    </script>
</body>
</html>
